<%@ page import="com.digimart.project.ConnectionProvider" %>
<%@ page import="java.sql.*" %>
<%@ page import="javax.servlet.http.HttpSession" %>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ include file="header.jsp" %>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Payment</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container">
    <h1 class="mt-5">Payment Details</h1>
    <%
        String userId = session.getAttribute("user_id").toString();
        String orderId = request.getParameter("order_id");

        Connection conn = null;
        ResultSet rs = null;

        try {
            conn = ConnectionProvider.getCon();
            // Retrieve order details for the user
            String orderQuery = "SELECT * FROM Orders WHERE order_id = ? AND user_id = ?";
            PreparedStatement orderStmt = conn.prepareStatement(orderQuery);
            orderStmt.setString(1, orderId);
            orderStmt.setString(2, userId);
            rs = orderStmt.executeQuery();

            if (rs.next()) {
                String orderDate = rs.getString("order_date");
                double totalAmount = rs.getDouble("total_amount");
                String deliveryAddress = rs.getString("delivery_address_id"); // Optional: Fetch actual address

                session.setAttribute("orderDate", orderDate);
                session.setAttribute("totalAmount", totalAmount);
                session.setAttribute("deliveryAddress", deliveryAddress);
    %>
                <h2 class="mt-4">Order Summary</h2>
                <div class="alert alert-info">
                    <strong>Order ID:</strong> <%= orderId %><br>
                    <strong>Order Date:</strong> <%= orderDate %><br>
                    <strong>Total Amount:</strong> $<%= totalAmount %><br>
                    <strong>Delivery Address:</strong> <%= deliveryAddress %> <!-- Optional: Fetch full address -->
                </div>

                <h2 class="mt-4">Payment Method</h2>
                <div class="alert alert-success">
                    Payment method selected: <strong>Cash on Delivery</strong>
                </div>
                
                <form action="ProcessPaymentServlet" method="post">
                    <input type="hidden" name="order_id" value="<%= orderId %>">
                    <button type="submit" class="btn btn-success">Place Order</button>
                </form>
    <%
            } else {
    %>
                <div class="alert alert-danger" role="alert">No order found!</div>
    <%
            }
        } catch (SQLException e) {
            e.printStackTrace();
    %>
            <div class="alert alert-danger" role="alert">Error retrieving order details!</div>
    <%
        } finally {
            if (rs != null) try { rs.close(); } catch (SQLException ignore) {}
            if (conn != null) try { conn.close(); } catch (SQLException ignore) {}
        }
    %>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
