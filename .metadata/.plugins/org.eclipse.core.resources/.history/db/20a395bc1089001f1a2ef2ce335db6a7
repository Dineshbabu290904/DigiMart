<%@page import="com.shopping.project.ConnectionProvider"%>
<%@page import="java.sql.*"%>
<%@page import="java.io.InputStream"%>
<%@page import="javax.servlet.http.Part"%>

<%
    // Get product details from request
    String id = request.getParameter("id");
    String name = request.getParameter("name");
    String category = request.getParameter("category");
    String description = request.getParameter("description");
    String price = request.getParameter("price");
    String unit = request.getParameter("unit");
    String available_qty = request.getParameter("available_qty");
    String status = request.getParameter("status");

    // Handle image upload
    Part filePart = request.getPart("image"); // Retrieves <input type="file" name="image">
    InputStream imageStream = null;
    if (filePart != null && filePart.getSize() > 0) {
        imageStream = filePart.getInputStream(); // Convert image to binary stream
    }

    try {
        // Establish connection
        Connection con = ConnectionProvider.getCon();
        
        // Prepare SQL insert statement
        String query = "INSERT INTO Products (product_id, name, category, description, price_per_unit, unit, available_qty, image, status) " +
                       "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)";
        PreparedStatement ps = con.prepareStatement(query);
        
        // Set values for prepared statement
        ps.setInt(1, Integer.parseInt(id));  // product_id
        ps.setString(2, name);  // name
        ps.setString(3, category);  // category
        ps.setString(4, description);  // description
        ps.setBigDecimal(5, new java.math.BigDecimal(price));  // price_per_unit
        ps.setString(6, unit);  // unit
        ps.setBigDecimal(7, new java.math.BigDecimal(available_qty));  // available_qty
        
        // If the image is uploaded, insert it as a binary stream, else insert NULL
        if (imageStream != null) {
            ps.setBlob(8, imageStream);  // image
        } else {
            ps.setNull(8, java.sql.Types.BLOB);  // No image provided
        }
        
        ps.setString(9, status);  // status

        // Execute the insert statement
        int result = ps.executeUpdate();
        
        if (result > 0) {
            // Redirect to the success page
            response.sendRedirect("addNewProduct.jsp?msg=done");
        } else {
            // If insertion failed, redirect to the error page
            response.sendRedirect("addNewProduct.jsp?msg=notdone");
        }

    } catch (Exception e) {
        e.printStackTrace();
        response.sendRedirect("addNewProduct.jsp?msg=error");
    }
%>
