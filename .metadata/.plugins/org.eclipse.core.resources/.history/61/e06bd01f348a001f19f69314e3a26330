<%@ page import="com.digimart.project.ConnectionProvider" %>
<%@ page import="java.math.BigDecimal" %>
<%@ page import="java.sql.*" %>
<%@ page import="java.util.Base64" %>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
<link rel="stylesheet" href="../css/addNewProduct-style.css">
<title>Edit Product</title>
<style>
.back {
  color: white;
  margin-left: 2.5%;
}
.container {
  display: flex;
  justify-content: space-between;
  padding: 20px;
}
.left-div, .right-div {
  flex: 1;
  margin: 10px;
}
button {
  background-color: #28a745; /* Green background */
  color: white; /* White text */
  border: none; /* No border */
  padding: 10px 20px; /* Padding */
  font-size: 16px; /* Font size */
  cursor: pointer; /* Pointer cursor on hover */
}
button:hover {
  background-color: #218838; /* Darker green on hover */
}
textarea {
  width: 100%;
  height: 100px;
}
input[type="file"] {
  margin-top: 10px;
}
</style>
</head>
<body>
<h2><a class="back" href="allProductEditProduct.jsp"><i class='fas fa-arrow-circle-left'></i> Back</a></h2>

<%
    String productId = request.getParameter("product_id");
	System.out.println(productId);
	session.setAttribute("productId", productId);
	System.out.println();
    if (productId != null) {
        try {
            Connection con = ConnectionProvider.getCon();
            PreparedStatement ps = con.prepareStatement("SELECT * FROM PRODUCTS WHERE product_id = ?");
            ps.setInt(1, Integer.parseInt(productId));
            ResultSet rs = ps.executeQuery();

            if (rs.next()) {
                // Retrieve data from the database
                int userId = rs.getInt("user_id");
                String name = rs.getString("name");
                String description = rs.getString("description");
                String category = rs.getString("category");
                BigDecimal pricePerUnit = rs.getBigDecimal("price_per_unit");
                String unit = rs.getString("unit");
                BigDecimal availableQty = rs.getBigDecimal("available_qty");
                Timestamp dateListed = rs.getTimestamp("date_listed");
                byte[] imageBytes = rs.getBytes("image");
                String status = rs.getString("status");

                // Convert image to base64 for displaying
                String imageBase64 = (imageBytes != null) ? Base64.getEncoder().encodeToString(imageBytes) : null;
%>

<form action="UpdateProductServlet" method="get" enctype="multipart/form-data">
  <input type="hidden" name="product_id" value="<%= productId %>">
  
  <div class="container">
    <div class="left-div">
      <h3>User ID</h3>
      <input class="input-style" type="number" name="user_id" value="<%= userId %>" required />
      <hr>
    </div>

    <div class="right-div">
      <h3>Name</h3>
      <input class="input-style" type="text" name="name" value="<%= name %>" required />
      <hr>
    </div>
  </div>

  <div class="container">
    <div class="left-div">
      <h3>Description</h3>
      <textarea class="input-style" name="description" required><%= description %></textarea>
      <hr>
    </div>

    <div class="right-div">
      <h3>Category</h3>
      <input class="input-style" type="text" name="category" value="<%= category %>" required />
      <hr>
    </div>
  </div>

  <div class="container">
    <div class="left-div">
      <h3>Price per Unit</h3>
      <input class="input-style" type="number" name="price_per_unit" value="<%= pricePerUnit %>" required step="0.01" />
      <hr>
    </div>

    <div class="right-div">
      <h3>Unit</h3>
      <input class="input-style" type="text" name="unit" value="<%= unit %>" required />
      <hr>
    </div>
  </div>

  <div class="container">
    <div class="left-div">
      <h3>Available Quantity</h3>
      <input class="input-style" type="number" name="available_qty" value="<%= availableQty %>" required />
      <hr>
    </div>
	<div class="right-div">
      <h3>Current Image</h3>
      <%
          if (imageBase64 != null) {
      %>
        <img src="data:image/jpeg;base64,<%= imageBase64 %>" alt="Product Image" width="100" height="100" />
      <%
          } else {
              out.println("<p>No image available</p>");
          }
      %>

  <div class="container">
    <div class="left-div">
      <h3>Date Listed</h3>
      <input class="input-style" type="datetime-local" name="date_listed" value="<%= new java.text.SimpleDateFormat("yyyy-MM-dd'T'HH:mm").format(dateListed) %>" required />
      <hr>
    </div>

    <div class="right-div">
      <h3>Status</h3>
      <select class="input-style" name="status" required>
        <option value="Available" <%= status.equals("Available") ? "selected" : "" %>>Available</option>
        <option value="Out of Stock" <%= status.equals("Out of Stock") ? "selected" : "" %>>Out of Stock</option>
      </select>
      <hr>
    </div>
  </div>

  <div style="text-align: center; margin-top: 20px;">
    <button type="submit" name="update">Update Product</button>
  </div>
</form>
<form method="post" action="UpdateProductServlet" enctype="multipart/form-data">
      <h3>New Image (optional)</h3>
      <input class="input-style" type="file" name="image" accept="image/*" />
      <hr>
    </div>
    <button type="submit">Update Product</button>
</form>


<%
            } else {
                out.println("<h3 style='color:red;'>Product not found!</h3>");
            }
        } catch (Exception e) {
            e.printStackTrace();
            out.println("<h3 style='color:red;'>Error fetching product data!</h3>");
        }
    } else {
        out.println("<h3 style='color:red;'>Invalid Product ID!</h3>");
    }
%>

</body>
</html>
