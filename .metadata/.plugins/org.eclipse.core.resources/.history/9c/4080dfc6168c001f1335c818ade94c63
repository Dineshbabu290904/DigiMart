package com.digimart.Servlet;


import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import com.digimart.project.ConnectionProvider;

@WebServlet("/AddAddressServlet")
public class AddAddressServlet extends HttpServlet {
    /**
	 * 
	 */
	private static final long serialVersionUID = 1L;

	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String userId = request.getSession().getAttribute("user_id").toString();
        String street = request.getParameter("street");
        String city = request.getParameter("city");
        String state = request.getParameter("state");
        String postalCode = request.getParameter("postal_code");
        String country = request.getParameter("country");
        String addressIdParam = request.getParameter("address_id");

        Connection conn = null;
        PreparedStatement pstmt = null;

        try {
            conn = ConnectionProvider.getCon();

            if (addressIdParam != null && !addressIdParam.isEmpty()) {
                // Update existing address
                int addressId = Integer.parseInt(addressIdParam);
                String updateQuery = "UPDATE Addresses SET street = ?, city = ?, state = ?, postal_code = ?, country = ? WHERE address_id = ? AND user_id = ?";
                pstmt = conn.prepareStatement(updateQuery);
                pstmt.setString(1, street);
                pstmt.setString(2, city);
                pstmt.setString(3, state);
                pstmt.setString(4, postalCode);
                pstmt.setString(5, country);
                pstmt.setInt(6, addressId);
                pstmt.setString(7, userId);
                pstmt.executeUpdate();
                response.sendRedirect("manage_addresses.jsp?msg=addressUpdated");
            } else {
                // Add new address
                String insertQuery = "INSERT INTO Addresses (user_id, street, city, state, postal_code, country) VALUES (?, ?, ?, ?, ?, ?)";
                pstmt = conn.prepareStatement(insertQuery);
                pstmt.setString(1, userId);
                pstmt.setString(2, street);
                pstmt.setString(3, city);
                pstmt.setString(4, state);
                pstmt.setString(5, postalCode);
                pstmt.setString(6, country);
                pstmt.executeUpdate();
                response.sendRedirect("manage_addresses.jsp?msg=addressAdded");
            }
        } catch (Exception e) {
            e.printStackTrace();
            response.sendRedirect("manage_addresses.jsp?msg=error");
        } finally {
            if (pstmt != null) try { pstmt.close(); } catch (SQLException ignore) {}
            if (conn != null) try { conn.close(); } catch (SQLException ignore) {}
        }
    }
}
