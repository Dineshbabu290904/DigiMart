<%@ page import="java.sql.*, java.io.*, javax.servlet.http.*, javax.servlet.ServletException" %>
<%@ page import="javax.servlet.annotation.MultipartConfig, javax.servlet.http.Part" %>
<%@ page import="com.shopping.project.ConnectionProvider" %>
<%@ page language="java" contentType="text/html; charset=ISO-8859-1" pageEncoding="ISO-8859-1"%>

<%@ page import="javax.servlet.annotation.MultipartConfig" %>
<%@ page import="javax.servlet.http.Part" %>

<%@ page isErrorPage="true" %>
<%@ page errorPage="error.jsp" %>

<%
    // Handling request parameters
    String name = request.getParameter("name");
    String category = request.getParameter("category");
    String price = request.getParameter("price");
    String available_qty = request.getParameter("available_qty");
    String description = request.getParameter("description");
    String unit = request.getParameter("unit");

    // Handle the image upload
    Part imagePart = request.getPart("image");
    InputStream imageStream = null;

    if (imagePart != null && imagePart.getSize() > 0) {
        imageStream = imagePart.getInputStream(); // Obtain the uploaded image
    }

    // Insert product details into the database
    try {
        // Database connection
        Connection con = ConnectionProvider.getCon();
        
        // SQL query for inserting a new product
        String query = "INSERT INTO Products (name, category, price_per_unit, available_qty, description, unit, image, status) VALUES (?, ?, ?, ?, ?, ?, ?, ?)";
        PreparedStatement pstmt = con.prepareStatement(query);

        // Set product details
        pstmt.setString(1, name);
        pstmt.setString(2, category);
        pstmt.setString(3, price);
        pstmt.setString(4, available_qty);
        pstmt.setString(5, description);
        pstmt.setString(6, unit);

        // Set image data if uploaded
        if (imageStream != null) {
            pstmt.setBinaryStream(7, imageStream, (int) imagePart.getSize());
        } else {
            pstmt.setNull(7, java.sql.Types.BLOB); // Handle null image
        }

        pstmt.setString(8, "Available"); // Default product status

        // Execute the query
        int result = pstmt.executeUpdate();

        // Check if insertion was successful
        if (result > 0) {
            out.println("<h3 class='alert'>Product Added Successfully!</h3>");
        } else {
            out.println("<h3 class='alert'>Something went wrong! Try Again!</h3>");
        }

    } catch (Exception e) {
        e.printStackTrace();
        out.println("<h3 class='alert'>Error: " + e.getMessage() + "</h3>");
    }
%>
