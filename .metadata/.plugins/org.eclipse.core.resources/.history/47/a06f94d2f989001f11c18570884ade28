package com.digimart.project;

import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@WebServlet("/addProduct")
public class AddProductServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;

    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        // Retrieve form data
        String name = request.getParameter("P_name");
        String category = request.getParameter("category");
        String description = request.getParameter("description");
        String price = request.getParameter("price");
        String unit = request.getParameter("unit");
        String available_qty = request.getParameter("available_qty");
        String status = request.getParameter("status");

        // Input validation
        if (name == null || name.trim().isEmpty() ||
            category == null || category.trim().isEmpty() ||
            description == null || description.trim().isEmpty() ||
            price == null || price.trim().isEmpty() ||
            unit == null || unit.trim().isEmpty() ||
            available_qty == null || available_qty.trim().isEmpty() ||
            status == null || status.trim().isEmpty()) {

            // Redirect back to the form if any field is empty
            response.sendRedirect("addNewProduct.jsp?msg=None");
            return;
        }

        try {
            // Get database connection
            Connection con = ConnectionProvider.getCon();

            // SQL query to insert product details
            String query = "INSERT INTO Products (name, category, price_per_unit, available_qty, description, unit, status) VALUES (?, ?, ?, ?, ?, ?, ?)";
            PreparedStatement ps = con.prepareStatement(query);
            
            // Set parameters for the SQL query
            ps.setString(1, name);
            ps.setString(2, category);
            ps.setDouble(3, Double.parseDouble(price));
            ps.setInt(4, Integer.parseInt(available_qty));
            ps.setString(5, description);
            ps.setString(6, unit);
            ps.setString(7, status);

            // Execute the query
            ps.executeUpdate();
            con.close();

            // Redirect to the form page with success message
            response.sendRedirect("addNewProduct.jsp?msg=done");
        } catch (Exception e) {
            e.printStackTrace();
            // Redirect to the form page with error message
            response.sendRedirect("addNewProduct.jsp?msg=invalid");
        }
    }

    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        doPost(request, response);
    }
}
