<%@page import="com.shopping.project.ConnectionProvider"%>
<%@page import="java.sql.*"%>

<%
String email = request.getParameter("email");
String phone = request.getParameter("phone");
String securityQuestion = request.getParameter("securityQuestion");
String answer = request.getParameter("answer");
String newPassword = request.getParameter("newPassword");

int check = 0;
try {
    Connection con = ConnectionProvider.getCon();
    PreparedStatement ps = con.prepareStatement("SELECT * FROM Users WHERE email = ? AND phone = ? AND securityQuestion = ? AND securityAnswer = ?");
    ps.setString(1, email);
    ps.setString(2, phone);
    ps.setString(3, securityQuestion);
    ps.setString(4, answer);
    ResultSet rs = ps.executeQuery();
    if (rs.next()) {
        PreparedStatement updatePs = con.prepareStatement("UPDATE Users SET password = ? WHERE email = ?");
        updatePs.setString(1, newPassword); 
        updatePs.setString(2, email);
        int rowsUpdated = updatePs.executeUpdate();
        if (rowsUpdated > 0) {
            System.out.println("Password updated successfully.");
            response.sendRedirect("forgotPassword?msg=done");
        } else {
        	System.out.println("Error updating password.");
        	response.sendRedirect("forgotPassword?msg=notdone");
        }
    } else {
    	System.out.println("Invalid details provided.");
    }
} catch (Exception e) {
    e.printStackTrace();
    System.out.println("Error: " + e.getMessage());
}
%>
